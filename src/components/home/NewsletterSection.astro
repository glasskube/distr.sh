---
const formsServerBaseUrl = import.meta.env.FORMS_SERVER;
const reCaptchaKeyV2 = import.meta.env.RE_CAPTCHA_KEY_v2;
---

<section class="py-8 md:py-16 lg:py-24 bg-gray-50 dark:bg-gray-800">
  <div class="container mx-auto px-4 max-w-3xl">
    <div class="text-center">
      <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-4">
        Distr Newsletter
      </h2>
      <p
        class="text-base md:text-lg text-gray-600 dark:text-gray-300 mb-6 md:mb-8">
        Sign-Up to get the latest product updates and release notes!
      </p>

      <form
        id="newsletterForm"
        data-forms-server={formsServerBaseUrl}
        data-sitekey={reCaptchaKeyV2}
        class="flex flex-col gap-4 justify-center items-center">
        <div
          id="emailStep"
          class="flex flex-col md:flex-row gap-4 justify-center w-full">
          <input
            type="email"
            id="email"
            name="email"
            required
            placeholder="your-email@corp.com"
            class="flex-1 px-6 py-3 md:py-4 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-[#00b5eb] focus:outline-none transition-colors"
          />
          <button
            type="button"
            id="verifyButton"
            class="px-8 py-3 md:py-4 bg-[#00b5eb] hover:bg-[#174c76] text-white font-medium rounded-lg transition-colors whitespace-nowrap cursor-pointer">
            Subscribe
          </button>
        </div>
        <div id="recaptchaStep" class="flex-col gap-4 items-center hidden">
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Please verify you're not a bot for <span
              id="emailDisplay"
              class="font-semibold"></span>
          </p>
          <div
            class="flex flex-col md:flex-row gap-4 items-center justify-center">
            <div>
              <div class="g-recaptcha"></div>
            </div>
            <button
              type="submit"
              id="submitButton"
              disabled
              class="px-8 py-3 md:py-4 bg-[#00b5eb] text-white font-medium rounded-lg transition-colors whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-[#00b5eb] cursor-pointer">
              Complete Subscription
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  // Load reCAPTCHA script
  function loadRecaptchaScript() {
    if (typeof window === 'undefined') return;

    const elementId = 'recaptcha-script';
    if (document.getElementById(elementId) === null) {
      const script = document.createElement('script');
      script.src = 'https://www.google.com/recaptcha/api.js';
      script.id = elementId;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
  }

  // Get form elements
  const form = document.getElementById('newsletterForm') as HTMLFormElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const verifyButton = document.getElementById(
    'verifyButton',
  ) as HTMLButtonElement;
  const submitButton = document.getElementById(
    'submitButton',
  ) as HTMLButtonElement;
  const emailStep = document.getElementById('emailStep') as HTMLDivElement;
  const recaptchaStep = document.getElementById(
    'recaptchaStep',
  ) as HTMLDivElement;
  const emailDisplay = document.getElementById(
    'emailDisplay',
  ) as HTMLSpanElement;

  let recaptchaVerified = false;

  // Define global callback for reCAPTCHA
  (window as any).onRecaptchaCallback = function (token: string) {
    recaptchaVerified = true;
    submitButton.disabled = false;
  };

  // Handle verify button click (first step)
  verifyButton?.addEventListener('click', () => {
    if (!emailInput.validity.valid) {
      emailInput.reportValidity();
      return;
    }

    // Load and render reCAPTCHA
    loadRecaptchaScript();

    const email = emailInput.value;

    // Hide email step, show reCAPTCHA step
    emailStep.classList.add('hidden');
    recaptchaStep.classList.remove('hidden');
    emailDisplay.textContent = email;

    // Render reCAPTCHA widget after script loads
    setTimeout(() => {
      const recaptchaElement = document.querySelector(
        '.g-recaptcha',
      ) as HTMLElement;
      const siteKey = form.dataset.sitekey;

      if (recaptchaElement && siteKey && (window as any).grecaptcha) {
        (window as any).grecaptcha.render(recaptchaElement, {
          sitekey: siteKey,
          callback: 'onRecaptchaCallback',
          size: 'normal',
        });
      }
    }, 500);
  });

  // Handle final form submission (second step)
  form?.addEventListener('submit', async e => {
    e.preventDefault();

    if (!recaptchaVerified) {
      alert('Please complete the reCAPTCHA verification.');
      return;
    }

    const email = emailInput.value;
    const formsServerBaseUrl = form.dataset.formsServer;

    try {
      const response = await fetch(formsServerBaseUrl + '/newsletter', {
        method: 'POST',
        headers: {
          'Content-type': 'application/json; charset=UTF-8',
        },
        body: JSON.stringify({email}),
      });

      if (response.ok) {
        alert('Email successfully added to our newsletter: ' + email);

        // Reset form state
        form.reset();
        recaptchaStep.classList.add('hidden');
        recaptchaStep.classList.remove('flex');
        emailStep.classList.remove('hidden');
        recaptchaVerified = false;
        submitButton.disabled = true;

        // Reset reCAPTCHA
        if ((window as any).grecaptcha) {
          (window as any).grecaptcha.reset();
        }
      } else {
        throw new Error('Failed to submit');
      }
    } catch (err) {
      console.error(err);
      alert('Failed to subscribe. Please try again.');
    }
  });
</script>
