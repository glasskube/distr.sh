---
import {Icon} from '@astrojs/starlight/components';
---

<script>
  class ThemeSwitcher extends HTMLElement {
    constructor() {
      super();
      const storedTheme =
        typeof localStorage !== 'undefined' &&
        localStorage.getItem('starlight-theme');
      const themeMode = storedTheme || 'auto';
      const theme =
        themeMode === 'auto'
          ? window.matchMedia('(prefers-color-scheme: light)').matches
            ? 'light'
            : 'dark'
          : themeMode;
      document.documentElement.dataset.theme = theme;
      document.documentElement.dataset.themeMode = themeMode;
      this.handleMouseDown = this.handleMouseDown.bind(this);
    }
    connectedCallback() {
      this.addEventListener('click', this.handleMouseDown);
    }
    disconnectedCallback() {
      this.removeEventListener('click', this.handleMouseDown);
    }
    private handleMouseDown(e: MouseEvent) {
      const currentTheme = localStorage.getItem('starlight-theme') || 'auto';
      let newTheme: string;

      if (currentTheme === 'light') {
        newTheme = 'dark';
      } else if (currentTheme === 'dark') {
        newTheme = 'auto';
      } else {
        newTheme = 'light';
      }

      const actualTheme =
        newTheme === 'auto'
          ? window.matchMedia('(prefers-color-scheme: light)').matches
            ? 'light'
            : 'dark'
          : newTheme;

      document.documentElement.dataset.theme = actualTheme;
      document.documentElement.dataset.themeMode = newTheme;
      localStorage.setItem(
        'starlight-theme',
        newTheme === 'auto' ? '' : newTheme,
      );
    }
  }
  customElements.define('theme-switcher', ThemeSwitcher);
</script>

<theme-switcher class="sl-flex">
  <Icon name="sun" class="theme-selector-light" />
  <Icon name="moon" class="theme-selector-dark" />
  <Icon name="laptop" class="theme-selector-auto" />
</theme-switcher>

<style>
  theme-switcher {
    align-items: center;
  }
  .theme-selector-light,
  .theme-selector-dark,
  .theme-selector-auto {
    user-select: none;
    z-index: 999999;
    position: relative;
    cursor: pointer;
  }
  .theme-selector-light:hover,
  .theme-selector-dark:hover,
  .theme-selector-auto:hover {
    color: var(--sl-color-accent-high);
  }
  :root[data-theme-mode='light'] {
    .theme-selector-light {
      display: inline-block;
    }
    .theme-selector-dark {
      display: none;
    }
    .theme-selector-auto {
      display: none;
    }
  }
  :root[data-theme-mode='dark'] {
    .theme-selector-light {
      display: none;
    }
    .theme-selector-dark {
      display: inline-block;
    }
    .theme-selector-auto {
      display: none;
    }
  }
  :root[data-theme-mode='auto'],
  :root:not([data-theme-mode]) {
    .theme-selector-light {
      display: none;
    }
    .theme-selector-dark {
      display: none;
    }
    .theme-selector-auto {
      display: inline-block;
    }
  }
  :root[data-theme='light'] .theme-selector-light:hover {
    color: var(--sl-color-accent);
  }
</style>
